<div>
  <h2>System Metrics</h2>
  <p>
    <button type="button" class="btn btn-primary" (click)="refresh()">
      <span class="fa fa-refresh" aria-hidden="true"></span>&nbsp;Refresh
    </button>
  </p>

  <h3>Health</h3>
  <div id="healthCheck" class="row">
    <div class="col-md-3">
      <div class="alert alert-success">
        <strong>Version info:</strong> <span>OK</span>
      </div>
    </div>
   
    <div class="col-md-3">
      <div class="alert" [ngClass]="{'alert-success': healthCheck?.details?.database?.status === 'UP', 'alert-danger': healthCheck?.details?.database?.status !== 'UP'}">
        <strong>Database: </strong>
        <span>{{ healthCheck?.details?.database?.status }}</span>
        <span *ngIf="healthCheck?.details?.database?.details?.error">
          <a class="hand" (click)="showDatabaseException = !showDatabaseException">
            <i class="fa fa-eye" aria-hidden="true"></i>
          </a>
          <div class="popover" *ngIf="showDatabaseException">
            <div class="popover-title">
              <h4>Stacktrace
                <button type="button" class="close" (click)="showDatabaseException = !showDatabaseException">x</button>
              </h4>
            </div>
            <div class="popover-content">
              <pre>{{ healthCheck.details.database.details.error }}</pre>
            </div>
          </div>
        </span>
      </div>
    </div>

    <div class="col-md-3">
      <div class="alert" [ngClass]="{'alert-success': healthCheck?.details?.mail?.status === 'UP', 'alert-danger': healthCheck?.details?.mail?.status !== 'UP'}">
        <strong>Email: </strong>
        <span>{{ healthCheck?.details?.mail?.status }}</span>
        <span *ngIf="healthCheck?.details?.mail?.details?.error">
          <a class="hand" (click)="showMailException = !showMailException">
            <i class="fa fa-eye" aria-hidden="true"></i>
          </a>
          <div class="popover" *ngIf="showMailException">
            <div class="popover-title">
              <h4>Stacktrace
                <button type="button" class="close" (click)="showMailException = !showMailException">x</button>
              </h4>
            </div>
            <div class="popover-content">
              <pre>{{ healthCheck.details.mail.details.error }}</pre>
            </div>
          </div>
        </span>
      </div>
    </div>
  </div>



  <h3>JVM Metrics</h3>
  <div class="row">
    <div class="col-md-4">
      <b>Memory</b>
      <p>Total Memory ({{ (metrics?.gauges?.['jvm.memory.total.used']?.value / 1000000) | toFixed }}M /
        {{ (metrics?.gauges?.['jvm.memory.total.max']?.value / 1000000) | toFixed }}M)
      </p>
      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-success" role="progressbar"
          [style.width.%]="((metrics?.gauges?.['jvm.memory.total.used']?.value / metrics?.gauges?.['jvm.memory.total.max']?.value) * 100) | toFixed"
          [attr.aria-valuenow]="((metrics?.gauges?.['jvm.memory.total.used']?.value / metrics?.gauges?.['jvm.memory.total.max']?.value) * 100) | toFixed"
          aria-valuemin="0"
          [attr.aria-valuemax]="(metrics?.gauges?.['jvm.memory.total.max']?.value / 1000000) | toFixed"
          [style.width.%]="(metrics?.gauges?.['jvm.memory.total.used']?.value * 100 / metrics?.gauges?.['jvm.memory.total.max']?.value)">
          {{ ((metrics?.gauges?.['jvm.memory.total.used']?.value / metrics?.gauges?.['jvm.memory.total.max']?.value) *
          100) | toFixed }}%
        </div>
      </div>
      <p>Heap Memory ({{ metrics?.gauges?.['jvm.memory.heap.used']?.value / 1000000 | toFixed }}M / {{
        metrics?.gauges?.['jvm.memory.heap.max']?.value / 1000000 | toFixed}}M)</p>
      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-success" role="progressbar"
          [attr.aria-valuenow]="(metrics?.gauges?.['jvm.memory.heap.used']?.value / 1000000) | toFixed"
          aria-valuemin="0" [attr.aria-valuemax]="(metrics?.gauges?.['jvm.memory.heap.max']?.value / 1000000) | toFixed"
          [style.width.%]="(metrics?.gauges?.['jvm.memory.heap.usage']?.value * 100) | toFixed">
          {{ (metrics?.gauges?.['jvm.memory.heap.usage']?.value * 100) | toFixed }}%
        </div>
      </div>
      <p>Non-Heap Memory ({{ metrics?.gauges?.['jvm.memory.non-heap.used']?.value / 1000000 | toFixed }}M / {{
        metrics?.gauges?.['jvm.memory.non-heap.max']?.value / 1000000 | toFixed }}M)</p>
      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-success" role="progressbar"
          [attr.aria-valuenow]="(metrics?.gauges?.['jvm.memory.non-heap.used']?.value / 1000000) | toFixed"
          aria-valuemin="0"
          [attr.aria-valuemax]="(metrics?.gauges?.['jvm.memory.non-heap.max']?.value / 1000000) | toFixed"
          [style.width.%]="(metrics?.gauges?.['jvm.memory.non-heap.usage']?.value * 100) | toFixed">
          {{ (metrics?.gauges?.['jvm.memory.non-heap.usage']?.value * 100) | toFixed }}%
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <b translate="metrics.jvm.threads.title">Threads</b>
      (Total: {{ metrics?.gauges?.['jvm.threads.count']?.value }})
      <a class="hand" data-bs-toggle="modal" data-bs-target="#threadDump">
        <i class="glyphicon glyphicon-eye-open"></i>
      </a>
      <p>Runnable {{ metrics?.gauges?.['jvm.threads.runnable.count']?.value }}</p>

      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-success" role="progressbar"
          [attr.aria-valuenow]="metrics?.gauges?.['jvm.threads.runnable.count']?.value" aria-valuemin="0"
          [attr.aria-valuemax]="metrics?.gauges?.['jvm.threads.count']?.value"
          [style.width.%]="(metrics?.gauges?.['jvm.threads.runnable.count']?.value * 100 / metrics?.gauges?.['jvm.threads.count']?.value) | toFixed">
          {{ (metrics?.gauges?.['jvm.threads.runnable.count']?.value * 100 /
          metrics?.gauges?.['jvm.threads.count']?.value) | toFixed}}%
        </div>
      </div>

      <p>Timed waiting ({{ metrics?.gauges?.['jvm.threads.timed_waiting.count']?.value }})</p>

      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar"
          [attr.aria-valuenow]="metrics?.gauges?.['jvm.threads.timed_waiting.count']?.value" aria-valuemin="0"
          [attr.aria-valuemax]="metrics?.gauges?.['jvm.threads.count']?.value"
          [style.width.%]="(metrics?.gauges?.['jvm.threads.timed_waiting.count']?.value * 100 / metrics?.gauges?.['jvm.threads.count']?.value) | toFixed">
          {{ (metrics?.gauges?.['jvm.threads.timed_waiting.count']?.value * 100 /
          metrics?.gauges?.['jvm.threads.count']?.value) | toFixed }}%
        </div>
      </div>

      <p>Waiting ({{ metrics?.gauges?.['jvm.threads.waiting.count']?.value }})</p>

      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar"
          [attr.aria-valuenow]="metrics?.gauges?.['jvm.threads.waiting.count']?.value" aria-valuemin="0"
          [attr.aria-valuemax]="metrics?.gauges?.['jvm.threads.count']?.value"
          [style.width.%]="(metrics?.gauges?.['jvm.threads.waiting.count']?.value * 100 / metrics?.gauges?.['jvm.threads.count']?.value) | toFixed">
          {{ (metrics?.gauges?.['jvm.threads.waiting.count']?.value * 100 /
          metrics?.gauges?.['jvm.threads.count']?.value) | toFixed }}%
        </div>
      </div>

      <p>Blocked ({{ metrics?.gauges?.['jvm.threads.blocked.count']?.value }})</p>

      <div class="progress">
        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar"
          [attr.aria-valuenow]="metrics?.gauges?.['jvm.threads.blocked.count']?.value" aria-valuemin="0"
          [attr.aria-valuemax]="metrics?.gauges?.['jvm.threads.count']?.value"
          [style.width.%]="(metrics?.gauges?.['jvm.threads.blocked.count']?.value * 100 / metrics?.gauges?.['jvm.threads.count']?.value) | toFixed">
          {{ (metrics?.gauges?.['jvm.threads.blocked.count']?.value * 100 /
          metrics?.gauges?.['jvm.threads.count']?.value) | toFixed }}%
        </div>
      </div>
    </div>



    <div class="col-md-4">
      <b>Garbage collections</b>
      <div class="row">
        <div class="col-md-9">Mark Sweep count</div>
        <div class="col-md-3">{{ metrics?.gauges?.['jvm.garbage.G1-Old-Generation.count']?.value }}</div>
      </div>
      <div class="row">
        <div class="col-md-9">Mark Sweep time</div>
        <div class="col-md-3">{{ metrics?.gauges?.['jvm.garbage.G1-Old-Generation.time']?.value }}ms</div>
      </div>
      <div class="row">
        <div class="col-md-9">Scavenge count</div>
        <div class="col-md-3">{{ metrics?.gauges?.['jvm.garbage.G1-Young-Generation.count']?.value }}</div>
      </div>
      <div class="row">
        <div class="col-md-9">Scavenge time</div>
        <div class="col-md-3">{{ metrics?.gauges?.['jvm.garbage.G1-Young-Generation.time']?.value }}ms</div>
      </div>
    </div>
  </div>


  <h3>HTTP requests (events per second)</h3>
  <p>Active requests <b>{{ metrics?.counters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.activeRequests']?.count
      }}</b> - Total requests <b>{{
      metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count }}</b></p>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Code</th>
          <th>Count</th>
          <th>Mean</th>
          <th>Average (1 min)</th>
          <th>Average (5 min)</th>
          <th>Average (15 min)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Ok</td>
          <td>
            <div class="progress">
              <div class="progress-bar bg-success" role="progressbar"
                [attr.aria-valuenow]="(metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.count * 100) / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [attr.aria-valuemin]="0"
                [attr.aria-valuemax]="metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [ngStyle]="{ width: (metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.count * 100 / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count) + '%' }">
                {{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.count }}
              </div>
            </div>
          </td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.mean_rate | number:'1.2-2' }}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.m1_rate |
            number:'1.2-2' }}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.m5_rate |
            number:'1.2-2'}}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.ok']?.m15_rate |
            number:'1.2-2'}}</td>
        </tr>

        <tr>
          <td>Not found</td>
          <td>
            <div class="progress">
              <div class="progress-bar bg-warning" role="progressbar"
                [attr.aria-valuenow]="(metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.count * 100) / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [attr.aria-valuemin]="0"
                [attr.aria-valuemax]="metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [ngStyle]="{ width: (metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.count * 100 / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count) + '%' }">
                {{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.count
                }}
              </div>
            </div>
          </td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.mean_rate
            | number:'1.2-2'}}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.m1_rate |
            number:'1.2-2'}}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.m5_rate |
            number:'1.2-2' }}</td>
          <td>{{ metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.notFound']?.m15_rate
            | number:'1.2-2' }}</td>
        </tr>

        <tr>
          <td>Server Error</td>
          <td>
            <div class="progress">
              <div class="progress-bar bg-danger" role="progressbar"
                [attr.aria-valuenow]="(metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.count * 100) / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [attr.aria-valuemin]="0"
                [attr.aria-valuemax]="metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count"
                [ngStyle]="{ width: (metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.count * 100 / metrics?.timers?.['io.dropwizard.metrics.servlet.InstrumentedFilter.requests']?.count) + '%' }">
                {{
                metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.count
                }}
              </div>
            </div>
          </td>
          <td>{{
            metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.mean_rate | number:'1.2-2'
            }}</td>
          <td>{{
            metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.m1_rate | number:'1.2-2'}}
          </td>
          <td>{{
            metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.m5_rate | number:'1.2-2'}}
          </td>
          <td>{{
            metrics?.meters?.['io.dropwizard.metrics.servlet.InstrumentedFilter.responseCodes.serverError']?.m15_rate | number:'1.2-2'}}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <h3>Services statistics (time in millisecond)</h3>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Service name</th>
            <th>Count</th>
            <th>Mean</th>
            <th>Min</th>
            <th>p50</th>
            <th>p75</th>
            <th>p95</th>
            <th>p99</th>
            <th>Max</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let key of getServiceKeys()">
            <td>{{ key }}</td>
            <td>{{ servicesStats[key]?.count }}</td>
            <td>{{ servicesStats[key]?.mean * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.min * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.p50 * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.p75 * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.p95 * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.p99 * 1000 | toFixed }}</td>
            <td>{{ servicesStats[key]?.max * 1000 | toFixed }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

